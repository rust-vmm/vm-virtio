# Fuzzing

To implement fuzzing, we're first writing in the guest memory descriptor chains. This is a way to mimic what a Virtio
Driver implementation would do.

This project uses [structure-aware fuzzing](https://rust-fuzz.github.io/book/cargo-fuzz/structure-aware-fuzzing.html).
When using structure-aware fuzzing, the fuzzer can initialize a user provided structure with random data. This can be 
achieved by deriving the `Arbitrary` trait on a user defined structure. One of the main components of the virtio-queue 
implementation and a structure that we'd like to be able to initialize from random data is the `Descriptor`. As Rust 
does not allow deriving foreign traits on foreign structure, we created a new structure called `FuzzingDescriptor`.
This structure contains the same fields as a regular descriptor, except that instead of using `Le64`, `Le32`, `Le16`,
it uses `u64`, `u32`, `u16`, because the former do not derive the `Arbitrary` trait, while the latter do.

## Fuzzing virtio_queue

For fuzzing virtio_queue we defined another enum called `VirtioQueueFunctionType`, which includes functions that we call
on the Queue object. Our initial target are functions called exclusively by the driver, but to mimic as close as 
possible the interactions between a device and a driver, we're also calling the functions that we would normally 
consider trusted.

The process of fuzzing a `virtio-queue` object is shown in the picture below:

![Fuzzing virtio_queue](img/Fuzzing%20virtio-queue.png)

The fuzzer generates random input and, with this input, a Vec of `FuzzingDescriptor` and a Vec of
`VirtioQueueFunctionType` are initialized. The `FuzzingDescriptor`s are then transformed into regular
`Descriptor`s. A `MockSplitQueue` object is initialized. Using it and the Vector of `Descriptor`s created,
we create multiple `DescriptorChain`s (using the `build_multiple_desc_chains` defined in `mock.rs`) with which we can
initialize the `GuestMemory`. Then we use the initialized `GuestMemory` to create a `Queue` object on which we call the 
functions generated by the fuzzer.

## To run cargo fuzz

cargo +nightly fuzz run virtio_queue_fuzz_target
